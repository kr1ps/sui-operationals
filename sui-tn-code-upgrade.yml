---
 - hosts: localhost

   vars:
     expected_checksum: 133fd85bcd79ed048a897be3a3f3bd4a2e9c616a
     dest_path: /home/tddr/sui
     node_service_name: sui-node
     binary_source: /home/tddr/sui/target/release/sui-node
     binary_dest: /opt/sui/bin/sui-node


   tasks:

   - name: 1- Delete sui directory directory
     file: 
      path: "{{ dest_path }}"
      state: absent

   - name: 2- Clone sui github repository for testnet branch
     git:
       repo: https://github.com/MystenLabs/sui.git
       dest: "{{ dest_path }}"
       version: testnet
  
   - name: 3- Compare the checksum
     ansible.builtin.command: ./compare.sh 'cd "{{ dest_path }}" && git rev-parse HEAD' "{{ expected_checksum }}"
     register: compare
   - name: show output for compare
     debug: 
       var: compare.stdout

   - name: 4- Update sui-client
     ansible.builtin.shell:
      cmd: cargo build --bin sui --release
      chdir: "{{ dest_path }}"
     register: sui_client
   - name: show output for update sui-client
     debug: 
       var: sui_client.stdout

   - name: 5- Update sui-node
     ansible.builtin.shell:
      cmd: cargo build --release --bin sui-node
      chdir: "{{ dest_path }}"
     register: sui_node
   - name: show output for update sui-node
     debug: 
       var: sui_node.stdout

   - name: 6- Stop Node Service if running
     become: true
     ansible.builtin.systemd:
       name: "{{ node_service_name }}"
       state: stopped
       
   - name: 7- Copy binary
     become: true
     ansible.builtin.copy:
       src: "{{ binary_source }}"
       dest: "{{ binary_dest }}"
       force: yes
       
   - name: 8- Start Node Service
     become: true
     ansible.builtin.systemd:
       name: "{{ node_service_name }}"
       state: started
       

